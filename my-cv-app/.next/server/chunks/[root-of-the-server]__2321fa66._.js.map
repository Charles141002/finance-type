{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///Users/charlespelong/Desktop/finance-type/my-cv-app/pages/api/cv/list.ts"],"sourcesContent":["import type { NextApiHandler } from 'next'\nimport { createPagesServerClient } from '@supabase/auth-helpers-nextjs'\n\nconst DEFAULT_LIMIT = 30\nconst MAX_LIMIT = 100\n\nconst handler: NextApiHandler = async (req, res) => {\n  if (req.method !== 'GET') {\n    res.setHeader('Allow', ['GET'])\n    return res.status(405).json({ error: 'Méthode non autorisée' })\n  }\n\n  const supabase = createPagesServerClient({ req, res })\n  const {\n    data: { session },\n  } = await supabase.auth.getSession()\n\n  if (!session?.user) {\n    return res.status(401).json({ error: 'Authentification requise.' })\n  }\n\n  const { limit: limitParam, offset: offsetParam, search: searchParam, sort: sortParam } = req.query\n\n  const parseNumberParam = (value: string | string[] | undefined, fallback: number) => {\n    if (typeof value === 'undefined') return fallback\n    const firstValue = Array.isArray(value) ? value[0] : value\n    const parsed = Number.parseInt(firstValue, 10)\n    return Number.isFinite(parsed) ? parsed : fallback\n  }\n\n  const limitFromQuery = parseNumberParam(limitParam, DEFAULT_LIMIT)\n  const limit = limitFromQuery === 0 ? 0 : Math.min(Math.max(limitFromQuery, 1), MAX_LIMIT)\n  const offset = Math.max(parseNumberParam(offsetParam, 0), 0)\n  const search = typeof searchParam === 'string' ? searchParam.trim() : Array.isArray(searchParam) ? searchParam[0]?.trim() ?? '' : ''\n\n  const sortMapping: Record<string, { column: 'updated_at' | 'created_at' | 'title'; ascending: boolean }> = {\n    updated_desc: { column: 'updated_at', ascending: false },\n    updated_asc: { column: 'updated_at', ascending: true },\n    created_desc: { column: 'created_at', ascending: false },\n    created_asc: { column: 'created_at', ascending: true },\n    title_asc: { column: 'title', ascending: true },\n    title_desc: { column: 'title', ascending: false },\n  }\n\n  const sortKey = typeof sortParam === 'string' ? sortParam : Array.isArray(sortParam) ? sortParam[0] : undefined\n  const { column: sortColumn, ascending } = sortMapping[sortKey ?? ''] ?? sortMapping.updated_desc\n\n  let query = supabase\n    .from('user_cvs')\n    .select('id, title, updated_at, created_at', { count: 'exact' })\n    .eq('user_id', session.user.id)\n\n  if (search) {\n    query = query.ilike('title', `%${search}%`)\n  }\n\n  query = query.order(sortColumn, { ascending })\n\n  const rangeLimit = limit === 0 ? null : limit\n\n  if (rangeLimit) {\n    query = query.range(offset, offset + rangeLimit - 1)\n  }\n\n  const { data, error, count } = await query\n\n  if (error) {\n    return res.status(500).json({ error: error.message })\n  }\n\n  const total = typeof count === 'number' ? count : data?.length ?? 0\n\n  return res.status(200).json({ cvs: data ?? [], total })\n}\n\nexport default handler\n"],"names":[],"mappings":";;;;AACA;;AAEA,MAAM,gBAAgB;AACtB,MAAM,YAAY;AAElB,MAAM,UAA0B,OAAO,KAAK;IAC1C,IAAI,IAAI,MAAM,KAAK,OAAO;QACxB,IAAI,SAAS,CAAC,SAAS;YAAC;SAAM;QAC9B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAwB;IAC/D;IAEA,MAAM,WAAW,IAAA,kMAAuB,EAAC;QAAE;QAAK;IAAI;IACpD,MAAM,EACJ,MAAM,EAAE,OAAO,EAAE,EAClB,GAAG,MAAM,SAAS,IAAI,CAAC,UAAU;IAElC,IAAI,CAAC,SAAS,MAAM;QAClB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA4B;IACnE;IAEA,MAAM,EAAE,OAAO,UAAU,EAAE,QAAQ,WAAW,EAAE,QAAQ,WAAW,EAAE,MAAM,SAAS,EAAE,GAAG,IAAI,KAAK;IAElG,MAAM,mBAAmB,CAAC,OAAsC;QAC9D,IAAI,OAAO,UAAU,aAAa,OAAO;QACzC,MAAM,aAAa,MAAM,OAAO,CAAC,SAAS,KAAK,CAAC,EAAE,GAAG;QACrD,MAAM,SAAS,OAAO,QAAQ,CAAC,YAAY;QAC3C,OAAO,OAAO,QAAQ,CAAC,UAAU,SAAS;IAC5C;IAEA,MAAM,iBAAiB,iBAAiB,YAAY;IACpD,MAAM,QAAQ,mBAAmB,IAAI,IAAI,KAAK,GAAG,CAAC,KAAK,GAAG,CAAC,gBAAgB,IAAI;IAC/E,MAAM,SAAS,KAAK,GAAG,CAAC,iBAAiB,aAAa,IAAI;IAC1D,MAAM,SAAS,OAAO,gBAAgB,WAAW,YAAY,IAAI,KAAK,MAAM,OAAO,CAAC,eAAe,WAAW,CAAC,EAAE,EAAE,UAAU,KAAK;IAElI,MAAM,cAAqG;QACzG,cAAc;YAAE,QAAQ;YAAc,WAAW;QAAM;QACvD,aAAa;YAAE,QAAQ;YAAc,WAAW;QAAK;QACrD,cAAc;YAAE,QAAQ;YAAc,WAAW;QAAM;QACvD,aAAa;YAAE,QAAQ;YAAc,WAAW;QAAK;QACrD,WAAW;YAAE,QAAQ;YAAS,WAAW;QAAK;QAC9C,YAAY;YAAE,QAAQ;YAAS,WAAW;QAAM;IAClD;IAEA,MAAM,UAAU,OAAO,cAAc,WAAW,YAAY,MAAM,OAAO,CAAC,aAAa,SAAS,CAAC,EAAE,GAAG;IACtG,MAAM,EAAE,QAAQ,UAAU,EAAE,SAAS,EAAE,GAAG,WAAW,CAAC,WAAW,GAAG,IAAI,YAAY,YAAY;IAEhG,IAAI,QAAQ,SACT,IAAI,CAAC,YACL,MAAM,CAAC,qCAAqC;QAAE,OAAO;IAAQ,GAC7D,EAAE,CAAC,WAAW,QAAQ,IAAI,CAAC,EAAE;IAEhC,IAAI,QAAQ;QACV,QAAQ,MAAM,KAAK,CAAC,SAAS,CAAC,CAAC,EAAE,OAAO,CAAC,CAAC;IAC5C;IAEA,QAAQ,MAAM,KAAK,CAAC,YAAY;QAAE;IAAU;IAE5C,MAAM,aAAa,UAAU,IAAI,OAAO;IAExC,IAAI,YAAY;QACd,QAAQ,MAAM,KAAK,CAAC,QAAQ,SAAS,aAAa;IACpD;IAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,MAAM;IAErC,IAAI,OAAO;QACT,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC;IACrD;IAEA,MAAM,QAAQ,OAAO,UAAU,WAAW,QAAQ,MAAM,UAAU;IAElE,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,KAAK,QAAQ,EAAE;QAAE;IAAM;AACvD;uCAEe","debugId":null}}]
}